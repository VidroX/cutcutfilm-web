FROM node:21.5

ENV APP_NAME cutcutfilm
ENV APP_HOME /app/${APP_NAME}/services/web
WORKDIR "$APP_HOME"

COPY package*.json ./

RUN npm install -g pm2
RUN npm install

COPY . .

ARG NODE_ENV
ARG DEBUG
ARG ENVIRONMENT_TYPE
ARG GATEWAY_SERVICE_LOCATION

ENV NODE_ENV ${NODE_ENV}
ENV NEXT_PUBLIC_DEBUG ${DEBUG}
ENV NEXT_PUBLIC_ENVIRONMENT_TYPE ${ENVIRONMENT_TYPE}
ENV NEXT_PUBLIC_GATEWAY_SERVICE_LOCATION ${GATEWAY_SERVICE_LOCATION:-${NEXT_PUBLIC_GATEWAY_SERVICE_LOCATION}}

RUN npm run build

CMD [ "pm2-runtime", "npm", "--", "start" ]